<!-- weeklyattendance.component.html -->

<!-- Header Section -->
<div class="attendance-container">
  <!-- Modal Overlay -->
  <div *ngIf="showCountdownModal" class="modal-overlay">
    <div class="modal-container">

      <!-- Modal Header -->
      <div class="modal-header-clean">
        <h5 class="modal-title-clean">
          <i class="bi bi-clock-history"></i>
          <span>{{ 'ATTENDANCE_EDITING_TIMER' | translate }}</span>
        </h5>
        <button type="button" class="modal-close-btn" (click)="closeCountdownModal()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body-clean">

        <!-- Message -->
        <p class="modal-message">{{ countdownMessage }}</p>

        <!-- Countdown Display (only show if counting) -->
        <div *ngIf="countdown.totalSeconds > 0" class="countdown-container">

          <!-- Time Boxes -->
          <div class="countdown-boxes">
            <div class="time-box">
              <div class="time-value">{{ countdown.hours }}</div>
              <div class="time-label">Hours</div>
            </div>

            <span class="time-separator">:</span>

            <div class="time-box">
              <div class="time-value">{{ countdown.minutes.toString().padStart(2, '0') }}</div>
              <div class="time-label">Minutes</div>
            </div>

            <span class="time-separator">:</span>

            <div class="time-box">
              <div class="time-value">{{ countdown.seconds.toString().padStart(2, '0') }}</div>
              <div class="time-label">Seconds</div>
            </div>
          </div>

          <!-- Compact Display -->
          <div class="compact-display">
            <i class="bi bi-hourglass-split"></i>
            <strong>{{ getCountdownDisplay() }}</strong> remaining
          </div>
        </div>

        <!-- Past Date Message -->
        <div *ngIf="countdown.totalSeconds === 0 && isPastDate(detailModalData.date || '')"
          class="alert-box alert-warning-clean">
          <i class="bi bi-exclamation-triangle-fill"></i>
          <span>This date has already passed and cannot be edited.</span>
        </div>

        <!-- Info Note -->
        <div class="info-note">
          <i class="bi bi-info-circle"></i>
          <span>Attendance can only be edited on the same day it occurs</span>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer-clean">
        <button type="button" class="btn-clean btn-secondary-clean" (click)="closeCountdownModal()">
          Close
        </button>
        <button type="button" class="btn-clean btn-primary-clean" (click)="closeCountdownModal(); resetToCurrentWeek()">
          <i class="bi bi-calendar-check"></i>
          Go to Today
        </button>
      </div>

    </div>
  </div>

  <!-- Alternative: Compact Inline Countdown (can be shown in table cells) -->
  <ng-template #compactCountdown>
    <div class="compact-countdown">
      <i class="bi bi-lock text-muted me-1"></i>
      <small class="text-muted">
        Available in {{ getCountdownDisplay() }}
      </small>
    </div>
  </ng-template>

  <div class="header-section">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2 class="mb-1">{{ 'WEEKLY_ATTENDANCE_GRID' | translate }}</h2>
        <p class="text-muted mb-0" *ngIf="gridData">
          <strong>{{ gridData.class.class_name }}</strong> |
          {{ gridData.period.start_date }} to {{ gridData.period.end_date }}
          <span class="badge bg-secondary ms-2">
            {{ gridData.students.length }} {{ 'TOTAL_STUDENTS' | translate }}
          </span>
        </p>
      </div>
      <div class="d-flex gap-2">
        <!-- Language Toggle -->
        <button class="btn btn-outline-info" (click)="languageService.toggleLanguage()" title="Switch Language">
          <i class="bi bi-translate"></i> {{ languageService.currentLang() === 'en' ? 'ខ្មែរ' : 'English' }}
        </button>

        <!-- Submit and Cancel buttons -->
        <div class=" me-2" *ngIf="hasUnsavedChanges">
          <button class="btn btn-success mx-2" (click)="submitAllChanges()" [disabled]="submitting">
            <i class="bi bi-check-circle"></i>
            {{ 'SUBMIT_CHANGES' | translate }} ({{ pendingUpdates.size }})
          </button>
          <button class="btn btn-danger" (click)="cancelAllChanges()" [disabled]="submitting">
            <i class="bi bi-x-circle"></i>
            {{ 'CANCEL' | translate }}
          </button>
        </div>

        <!-- Action buttons -->
        <button class="btn btn-outline-success" (click)="refresh()" [disabled]="loading || submitting"
          [title]="'REFRESH' | translate">
          <i class="bi bi-arrow-clockwise"></i> {{ 'REFRESH' | translate }}
        </button>
        <button class="btn btn-outline-primary" (click)="exportToExcel()" [disabled]="!gridData"
          [title]="'EXPORT_EXCEL' | translate">
          <i class="bi bi-file-earmark-excel"></i> {{ 'EXPORT_EXCEL' | translate }}
        </button>
        <button class="btn btn-outline-secondary" (click)="print()" [disabled]="!gridData" title="Print grid">
          <i class="bi bi-printer"></i>
        </button>
      </div>
    </div>

    <!-- Controls -->
    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label fw-semibold">{{ 'CLASS' | translate }}</label>
        <select class="form-select" [(ngModel)]="selectedClassId" (change)="onClassChange()"
          [disabled]="loading || submitting">
          <option *ngFor="let item of classes" [value]="item.class_id">{{ item.class_code }}</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold">{{ 'START_DATE' | translate }}</label>
        <input type="date" class="form-control" [(ngModel)]="startDate" (change)="onDateChange()"
          [disabled]="loading || submitting" [max]="endDate">
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold">{{ 'END_DATE' | translate }}</label>
        <input type="date" class="form-control" [(ngModel)]="endDate" (change)="onDateChange()"
          [disabled]="loading || submitting" [min]="startDate">
      </div>
      <div class="col-md-3 d-flex align-items-end gap-2">
        <button class="btn btn-outline-secondary" (click)="previousWeek()" [disabled]="loading || submitting"
          [title]="'PREVIOUS_WEEK' | translate">
          <i class="bi bi-chevron-left"></i>
        </button>
        <button class="btn btn-outline-secondary" (click)="nextWeek()" [disabled]="loading || submitting"
          [title]="'NEXT_WEEK' | translate">
          <i class="bi bi-chevron-right"></i>
        </button>
        <button class="btn-clean btn-primary-clean" (click)="resetToCurrentWeek()" [disabled]="loading || submitting"
          [title]="'RESET_CURRENT' | translate">
          {{ 'RESET_CURRENT' | translate }}<i class="bi bi-x-circle"></i>
        </button>
      </div>
    </div>

    <!-- Search Box -->
    <div class="row mb-3 d-flex justify-content-between align-items-end" *ngIf="gridData">
      <div class="col-md-6">
        <label class="form-label fw-semibold">
          <i class="bi bi-search"></i> {{ 'SEARCH_PLACEHOLDER' | translate }}
        </label>
        <div class="input-group">
          <input type="text" class="form-control" [(ngModel)]="searchQuery" (keyup.enter)="onSearch()"
            [placeholder]="'SEARCH_PLACEHOLDER' | translate" [disabled]="loading || submitting">
          <button class="btn btn-outline-primary" type="button" (click)="onSearch()" [disabled]="loading || submitting">
            <i class="bi bi-search"></i>
          </button>
          <button class="btn btn-outline-secondary" type="button" (click)="clearSearch()" [disabled]="!searchQuery"
            title="Clear search">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <small class="text-muted" *ngIf="searchQuery && !loading">
          {{ 'FOUND_STUDENTS' | translate }} {{ totalStudents }} {{ 'MATCHING' | translate }} "{{ searchQuery }}"
        </small>
      </div>
      <div class="col-6">
        <button class="btn-clean btn-primary-clean" routerLink="/">
          <i class="bi bi-arrow-left"></i> {{ 'BACK_TO_DASHBOARD' | translate }}
        </button>
      </div>
    </div>

    <!-- NEW: Bulk Selection Panel -->
    <div *ngIf="showBulkSelectionPanel && currentBulkDate" class="bulk-selection-panel alert alert-info mb-3">
      <!-- ... existing bulk panel code ... -->
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">
          <i class="bi bi-check-square me-2"></i>
          {{ 'BULK_SELECTION_MODE' | translate }} - {{ getFormattedDate(currentBulkDate) }}
        </h5>
        <button type="button" class="btn-close" (click)="cancelBulkSelection(currentBulkDate)" aria-label="Close">
        </button>
      </div>

      <div class="row g-3">
        <!-- Status Selection -->
        <div class="col-md-3">
          <label class="form-label fw-bold">{{ 'MARK_AS' | translate }}:</label>
          <select class="form-select" [(ngModel)]="getBulkSelectionState(currentBulkDate)!.selectedStatus">
            <option *ngFor="let status of statusOptions" [value]="status.value">
              {{ status.label }} ({{ status.symbol }})
            </option>
          </select>
        </div>

        <!-- Selection Actions -->
        <div class="col-md-9">
          <label class="form-label fw-bold">Students:</label>
          <div class="d-flex gap-2 flex-wrap">
            <button type="button" class="btn btn-sm btn-outline-primary" (click)="selectAllStudents(currentBulkDate)">
              <i class="bi bi-check-all me-1"></i>
              {{ 'SELECT_ALL' | translate }} ({{ getFilteredStudents().length }})
            </button>

            <button type="button" class="btn btn-sm btn-outline-secondary"
              (click)="deselectAllStudents(currentBulkDate)">
              <i class="bi bi-x-square me-1"></i>
              {{ 'DESELECT_ALL' | translate }}
            </button>

            <div class="vr"></div>

            <span class="badge bg-primary fs-6 d-flex align-items-center">
              {{ 'SELECTED' | translate }}: {{ getSelectedStudentCount(currentBulkDate) }}
            </span>

            <button type="button" class="btn btn-sm btn-success"
              [disabled]="getSelectedStudentCount(currentBulkDate) === 0"
              (click)="applyBulkAttendance(currentBulkDate)">
              <i class="bi bi-save me-1"></i>
              {{ 'APPLY_TO_SELECTED' | translate }}
            </button>

            <button type="button" class="btn btn-sm btn-outline-danger" (click)="cancelBulkSelection(currentBulkDate)">
              <i class="bi bi-x-circle me-1"></i>
              Cancel
            </button>
          </div>
        </div>
      </div>

      <div class="mt-2">
        <small class="text-muted">
          <i class="bi bi-info-circle me-1"></i>
          Click on student rows to select/deselect them. Changes will be staged and can be submitted together.
        </small>
      </div>
    </div>

    <!-- NEW: Global Bulk Actions Toolbar (Row Based) -->
    <div *ngIf="showGlobalBulkPanel && !showBulkSelectionPanel"
      class="global-bulk-panel alert alert-primary mb-3 shadow-sm border-primary">
      <div class="d-flex flex-wrap align-items-center justify-content-between p-1">
        <div class="d-flex align-items-center gap-3">
          <div class="fs-5 fw-bold text-primary">
            <i class="bi bi-check2-circle"></i>
            {{ globalSelectedStudents.size }} {{ 'SELECTED' | translate }}
          </div>
          <div class="vr"></div>
          <div class="d-flex align-items-center gap-2">
            <label class="fw-semibold small">{{ 'QUICK_ACTION' | translate }}:</label>
            <button class="btn btn-sm btn-success"
              (click)="applyGlobalBulkAction('P')">{{ 'PRESENT' | translate }}</button>
            <button class="btn btn-sm btn-danger"
              (click)="applyGlobalBulkAction('A')">{{ 'ABSENT' | translate }}</button>
            <!-- More actions dropdown if needed -->
            <div class="btn-group" role="group">
              <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown"
                aria-expanded="false">
                More
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="javascript:void(0)"
                    (click)="applyGlobalBulkAction('L')">{{ 'LATE' | translate }}</a></li>
                <li><a class="dropdown-item" href="javascript:void(0)"
                    (click)="applyGlobalBulkAction('E')">{{ 'EXCUSED' | translate }}</a></li>
              </ul>
            </div>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <small class="text-muted fst-italic me-2">{{ 'APPLIES_TO_TODAY' | translate }}
            ({{ getFormattedDate(todayDate) }})</small>
          <button class="btn btn-sm btn-outline-secondary" (click)="clearGlobalSelection()">
            <i class="bi bi-x-lg"></i> {{ 'CLEAR_SELECTION' | translate }}
          </button>
        </div>
      </div>
    </div>


    <!-- Warning banner for unsaved changes -->
    <div class="alert alert-warning d-flex align-items-center" role="alert" *ngIf="hasUnsavedChanges">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      <div>
        {{ 'UNSAVED_CHANGES' | translate }} <strong>{{ pendingUpdates.size }}</strong>
        {{ 'UNSAVED_CHANGES_COUNT' | translate }}.
        {{ 'SUBMIT_CHANGES' | translate }}
      </div>
    </div>

    <!-- Legend -->
    <div class="legend-container mb-3 p-3 bg-light rounded">
      <div class="d-flex flex-wrap gap-3 align-items-center">
        <span class="fw-semibold text-muted me-2">{{ 'LEGEND' | translate }}:</span>
        <span class="legend-item">
          <span class="legend-badge status-present">✓</span>
          <span class="ms-1">{{ 'PRESENT' | translate }} (P)</span>
        </span>
        <span class="legend-item">
          <span class="legend-badge status-absent">A</span>
          <span class="ms-1">{{ 'ABSENT' | translate }} (A)</span>
        </span>
        <span class="legend-item">
          <span class="legend-badge status-late">L</span>
          <span class="ms-1">{{ 'LATE' | translate }} (L)</span>
        </span>
        <span class="legend-item">
          <span class="legend-badge status-excused">E</span>
          <span class="ms-1">{{ 'EXCUSED' | translate }} (E)</span>
        </span>
        <span class="legend-item ms-3">
          <span class="badge bg-info text-white"><i class="bi bi-info-circle"></i></span>
          <span class="ms-1">= {{ 'VIEW_SUBJECT_DETAILS' | translate }}</span>
        </span>
      </div>
    </div>

  </div>

  <!-- Loading state -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Loading attendance data...</p>
  </div>

  <!-- Error state -->
  <div *ngIf="error" class="alert alert-danger" role="alert">
    <i class="bi bi-exclamation-circle"></i> {{ error }}
  </div>

  <!-- Attendance Grid -->
  <div *ngIf="!loading && gridData" class="grid-wrapper">
    <div class="table-responsive">
      <table class="table table-bordered attendance-table">
        <thead class="table-light">
          <!-- Main Header Row: Dates span multiple columns -->
          <tr class="header-row">
            <th class="col-select sticky-col text-center" rowspan="2" style="background-color: #f8f9fa;">
              <input type="checkbox" class="form-check-input"
                [checked]="globalSelectedStudents.size > 0 && globalSelectedStudents.size === totalStudents"
                [indeterminate]="globalSelectedStudents.size > 0 && globalSelectedStudents.size < totalStudents"
                (change)="toggleGlobalSelectAll($event)">
            </th>
            <th class="col-no sticky-col" rowspan="2">#</th>
            <th class="col-name-kh sticky-col" rowspan="2">{{ 'NAME_KHMER' | translate }}</th>
            <th class="col-name-eng sticky-col" rowspan="2">{{ 'NAME_ENGLISH' | translate }}</th>
            <th class="col-gender sticky-col" rowspan="2">{{ 'SEX' | translate }}</th>

            <!-- Date Columns: Span based on subject count -->
            <ng-container *ngFor="let dateString of gridData.period.dates; trackBy: trackByDate">
              <th [attr.colspan]="getSubjectsForDate(dateString).length || 1"
                class="text-center date-header-group date-divider-right"
                [ngClass]="{ 'today-column': isToday(dateString) }">
                <div class="d-flex flex-column align-items-center justify-content-center p-1">
                  <span class="fw-bold">{{ getFormattedDate(dateString) }}</span>
                  <div class="bulk-actions-micro mt-1"
                    *ngIf="isDateEditable(dateString) && getSubjectsForDate(dateString).length > 0">
                    <!-- Global Actions for this Date (optional) -->
                    <i class="bi bi-gear text-muted" style="cursor: pointer; font-size: 0.8rem"
                      [title]="'Manage ' + dateString" (click)="toggleBulkSelection(dateString)"></i>
                  </div>
                </div>
              </th>
            </ng-container>

            <!-- Statistics Headers -->
            <th class="col-stat text-center bg-light border-start text-success" title="Present" rowspan="2">
              <i class="bi bi-check-circle-fill"></i>
            </th>
            <th class="col-stat text-center bg-light text-danger" title="Absent" rowspan="2">
              <i class="bi bi-x-circle-fill"></i>
            </th>
            <th class="col-stat text-center bg-light text-warning" title="Late" rowspan="2">
              <i class="bi bi-clock-fill"></i>
            </th>
            <th class="col-stat text-center bg-light text-info" title="Excused" rowspan="2">
              <i class="bi bi-envelope-paper-fill"></i>
            </th>
            <th class="col-stat text-center bg-light border-start" title="Rate" rowspan="2">
              <span class="small fw-bold">%</span>
            </th>
          </tr>

          <!-- Sub Header Row: Subjects -->
          <tr class="sub-header-row">
            <ng-container *ngFor="let dateString of gridData.period.dates; trackBy: trackByDate">
              <!-- If subjects exist -->
              <ng-container *ngFor="let subject of getSubjectsForDate(dateString); trackBy: trackBySubject">
                <th class="subject-header-cell" [title]="subject.subject_name">
                  <div class="subject-header-content">
                    <span class="subject-code text-truncate" style="max-width: 100%;">
                      {{ subject.subject_code || (subject.subject_name | slice:0:3) | uppercase }}
                    </span>
                  </div>
                </th>
              </ng-container>
              <!-- If no subjects -->
              <th *ngIf="getSubjectsForDate(dateString).length === 0" class="subject-header-cell date-divider-right">
                <span class="no-subject-header">-</span>
              </th>
            </ng-container>
          </tr>
        </thead>

        <tbody>
          <!-- No search results message -->
          <tr *ngIf="searchQuery && getFilteredStudents().length === 0">
            <td colspan="100" class="text-center py-4">
              <i class="bi bi-search text-muted" style="font-size: 2rem;"></i>
              <p class="text-muted mb-0 mt-2">
                No students found matching "<strong>{{ searchQuery }}</strong>"
              </p>
              <button class="btn btn-sm btn-link" (click)="clearSearch()">
                Clear search
              </button>
            </td>
          </tr>

          <!-- Student rows -->
          <tr *ngFor="let student of getFilteredStudents(); let i = index; trackBy: trackByStudent" class="student-row"
            [class.table-active]="i % 2 === 0 || isStudentGloballySelected(student.student_id)">
            <td class="col-select sticky-col text-center"
              (click)="toggleGlobalStudentSelection(student.student_id); $event.stopPropagation()">
              <input type="checkbox" class="form-check-input" [checked]="isStudentGloballySelected(student.student_id)"
                (click)="$event.stopPropagation(); toggleGlobalStudentSelection(student.student_id)">
            </td>
            <td class="col-no sticky-col">
              <span [innerHTML]="highlightSearch(student.row_number.toString())"></span>
            </td>
            <td class="col-name-kh sticky-col">
              <span [innerHTML]="highlightSearch(student.student_name_kh)"></span>
            </td>
            <td class="col-name-eng sticky-col">
              <span [innerHTML]="highlightSearch(student.student_name_eng)"></span>
            </td>
            <td class="col-gender text-center sticky-col">
              <i [ngClass]="getGenderIconClass(student.gender)"></i>
              {{ student.gender }}
            </td>

            <!-- Attendance Cells -->
            <ng-container *ngFor="let dateString of gridData.period.dates; trackBy: trackByDate">
              <!-- Loop subjects -->
              <ng-container *ngFor="let subject of getSubjectsForDate(dateString); trackBy: trackBySubject">
                <td class="attendance-cell text-center" [ngClass]="{
                        'pending-change': hasPendingChanges(student.student_id, dateString, subject.subject_id),
                        'clickable': !isEditMode(student.student_id, dateString, subject.subject_id),
                        'bulk-selection-active': isBulkSelectionActive(dateString),
                        'student-selected': isStudentSelected(dateString, student.student_id)
                      }"
                  [class]="getStatusClass(getSubjectStatus(student, dateString, subject.subject_id), dateString)"
                  (click)="onCellClick(student.student_id, dateString, subject.subject_id)">

                  <!-- Bulk checkbox -->
                  <div *ngIf="isBulkSelectionActive(dateString)" class="bulk-checkbox-overlay">
                    <input type="checkbox" class="form-check-input"
                      [checked]="isStudentSelected(dateString, student.student_id)" (click)="$event.stopPropagation()">
                  </div>

                  <!-- Display -->
                  <ng-container
                    *ngIf="!isBulkSelectionActive(dateString) && !isEditMode(student.student_id, dateString, subject.subject_id)">
                    <span class="status-symbol">
                      {{ getStatusSymbol(getSubjectStatus(student, dateString, subject.subject_id)) }}
                    </span>
                  </ng-container>

                  <!-- Edit Mode -->
                  <div
                    *ngIf="!isBulkSelectionActive(dateString) && isEditMode(student.student_id, dateString, subject.subject_id)"
                    class="edit-mode" (click)="$event.stopPropagation()">
                    <div class="btn-group-vertical btn-group-sm">
                      <button *ngFor="let option of statusOptions" class="btn btn-outline-secondary"
                        [ngClass]="getStatusClass(option.value)"
                        (click)="stageAttendanceUpdate(student.student_id, dateString, option.value, subject.subject_id); $event.stopPropagation()">
                        {{ option.symbol }}
                      </button>
                    </div>
                    <button class="btn btn-sm btn-secondary mt-1 w-100" style="font-size: 0.5rem; padding: 0;"
                      (click)="closeEditMode(student.student_id, dateString, subject.subject_id); $event.stopPropagation()">
                      X
                    </button>
                  </div>
                </td>
              </ng-container>

              <!-- Empty cell if no subjects -->
              <td *ngIf="getSubjectsForDate(dateString).length === 0"
                class="attendance-cell text-center bg-light text-muted date-divider-right"
                (click)="showNoSubjectAlert(dateString)" style="cursor: pointer;">
                <small>-</small>
              </td>
            </ng-container>

            <!-- Statistics -->
            <td class="col-stat text-center">{{ student.statistics.present }}</td>
            <td class="col-stat text-center">{{ student.statistics.absent }}</td>
            <td class="col-stat text-center">{{ student.statistics.late }}</td>
            <td class="col-stat text-center">{{ student.statistics.excused }}</td>
            <td class="col-stat text-center" [ngClass]="getAttendanceRateColor(student.statistics.attendance_rate)">
              <strong>{{ student.statistics.attendance_rate }}</strong>
            </td>
          </tr>
        </tbody>

        <!-- Footer -->
        <tfoot class="table-secondary">
          <!-- Keep footer simple for now, spanning all cols -->
          <tr class="totals-row">
            <td colspan="5" class="text-end sticky-col"><strong>{{ 'TOTALS' | translate }}:</strong></td>
            <td [attr.colspan]="999">
              <div class="d-flex gap-4">
                <span>{{ 'PRESENT' | translate }}: {{ gridData.overall_statistics?.present }}</span>
                <span>{{ 'ABSENT' | translate }}: {{ gridData.overall_statistics?.absent }}</span>
                <span>{{ 'RATE' | translate }}: {{ gridData.overall_statistics?.attendance_rate }}</span>
              </div>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Pagination Controls -->
    <div class="d-flex justify-content-between align-items-center mt-3" *ngIf="totalPages > 1">
      <div class="d-flex align-items-center gap-2">
        <select class="form-select form-select-sm" style="width: 70px" [(ngModel)]="pageSize"
          (change)="onPageSizeChange()">
          <option [value]="10">10</option>
          <option [value]="20">20</option>
          <option [value]="50">50</option>
          <option [value]="100">100</option>
        </select>
        <span class="text-muted small">Items per page</span>
      </div>

      <nav aria-label="Page navigation">
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <button class="page-link" (click)="previousPage()" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </button>
          </li>

          <li class="page-item disabled">
            <span class="page-link">Page {{ currentPage }} of {{ totalPages }}</span>
          </li>

          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <button class="page-link" (click)="nextPage()" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </button>
          </li>
        </ul>
      </nav>

      <span class="text-muted small">
        Showing {{ (currentPage - 1) * pageSize + 1 }} - {{ Math.min(currentPage * pageSize, totalStudents) }}
        of {{ totalStudents }} students
      </span>
    </div>

  </div>

  <!-- Summary Cards -->
  <div *ngIf="!loading && gridData" class="row mt-4">
    <div class="col-md-3">
      <div class="card summary-card">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">{{ 'TOTAL_STUDENTS' | translate }}</h6>
          <h3 class="card-title">{{ gridData.overall_statistics?.total_students || 0 }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card summary-card">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">{{ 'TOTAL_PRESENT_DAYS' | translate }}</h6>
          <h3 class="card-title text-success">{{ gridData.overall_statistics?.present || 0 }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card summary-card">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">{{ 'TOTAL_ABSENT_DAYS' | translate }}</h6>
          <h3 class="card-title text-danger">{{ gridData.overall_statistics?.absent || 0 }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card summary-card">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">{{ 'ATTENDANCE_RATE' | translate }}</h6>
          <h3 class="card-title" [ngClass]="getAttendanceRateColor(gridData.overall_statistics?.attendance_rate)">
            {{ gridData.overall_statistics?.attendance_rate || '0%' }}
          </h3>
        </div>
      </div>
    </div>
  </div>

  <!-- NEW: Detail Modal for Subject-Level Attendance -->
  <div class="modal fade" [class.show]="showDetailModal" [style.display]="showDetailModal ? 'block' : 'none'"
    tabindex="-1" role="dialog" *ngIf="showDetailModal">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <i class="bi bi-calendar-check me-2"></i>
            Attendance Details
          </h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeDetailModal()"></button>
        </div>

        <div class="modal-body">
          <!-- Student Info -->
          <div class="student-info mb-3">
            <h6>
              <i [ngClass]="getGenderIconClass(detailModalData.student?.gender || '')"></i>
              {{ detailModalData.student?.student_name_eng }}
              <small class="text-muted">({{ detailModalData.student?.student_name_kh }})</small>
            </h6>
            <p class="mb-1">
              <strong>Date:</strong> {{ detailModalData.date }}
            </p>
            <p class="mb-0">
              <strong>Daily Status:</strong>
              <span class="badge ms-2" [ngClass]="{
                      'bg-success': getDailyStatus(detailModalData.student!, detailModalData.date!) === 'P',
                      'bg-danger': getDailyStatus(detailModalData.student!, detailModalData.date!) === 'A',
                      'bg-warning': getDailyStatus(detailModalData.student!, detailModalData.date!) === 'L',
                      'bg-info': getDailyStatus(detailModalData.student!, detailModalData.date!) === 'E'
                    }">
                {{ getDailyStatus(detailModalData.student!, detailModalData.date!) || 'Not Recorded' }}
              </span>
            </p>
          </div>

          <hr>

          <!-- Subject-level breakdown -->
          <h6 class="mb-3">
            <i class="bi bi-book me-2"></i>
            Subject-Level Attendance
          </h6>

          <div *ngIf="detailModalData.subjects && detailModalData.subjects.length > 0; else noSubjects">
            <table class="table table-sm table-hover">
              <thead class="table-light">
                <tr>
                  <th width="50">#</th>
                  <th>Subject Name</th>
                  <th width="100" class="text-center">Status</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let subject of detailModalData.subjects; let idx = index" [ngClass]="{
                      'table-danger': subject.status === 'A',
                      'table-warning': subject.status === 'L',
                      'table-info': subject.status === 'E',
                      'table-success': subject.status === 'P'
                    }">
                  <td>{{ idx + 1 }}</td>
                  <td>
                    <strong>{{ subject.subject_name }}</strong>
                  </td>
                  <td class="text-center">
                    <span class="badge" [ngClass]="{
                            'bg-success': subject.status === 'P',
                            'bg-danger': subject.status === 'A',
                            'bg-warning text-dark': subject.status === 'L',
                            'bg-info': subject.status === 'E'
                          }">
                      {{ getStatusSymbol(subject.status) }}
                      {{
                        subject.status === 'P' ? 'Present' :
                        subject.status === 'A' ? 'Absent' :
                        subject.status === 'L' ? 'Late' :
                        subject.status === 'E' ? 'Excused' : 'Unknown'
                      }}
                    </span>
                  </td>
                  <td>
                    <small>{{ subject.notes || '-' }}</small>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- Summary -->
            <div class="alert alert-info mt-3">
              <strong><i class="bi bi-info-circle me-1"></i> Summary:</strong>
              <ng-container *ngIf="getAbsentSubjectCount(detailModalData.student!, detailModalData.date!) > 0">
                Student was absent in
                <strong>{{ getAbsentSubjectCount(detailModalData.student!, detailModalData.date!) }}</strong>
                out of <strong>{{ detailModalData.subjects.length }}</strong> subjects on this day.
                This counts as <strong>1 absent day</strong> in the overall statistics.
              </ng-container>
              <ng-container *ngIf="getAbsentSubjectCount(detailModalData.student!, detailModalData.date!) === 0">
                Student attended all {{ detailModalData.subjects.length }} subjects on this day.
              </ng-container>
            </div>
          </div>

          <ng-template #noSubjects>
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle me-2"></i>
              No subject attendance records found for this date.
            </div>
          </ng-template>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeDetailModal()">
            <i class="bi bi-x-circle me-1"></i>
            {{ 'CLOSE' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal backdrop -->
  <div class="modal-backdrop fade" [class.show]="showDetailModal" *ngIf="showDetailModal" (click)="closeDetailModal()">
  </div>
</div>