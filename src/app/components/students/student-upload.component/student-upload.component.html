<div class="main-container">

    <!-- Page Header -->
    <div class="page-header">
        <h1><i class="bi bi-file-earmark-spreadsheet"></i> Upload Students from Excel</h1>
        <p>Import student data easily using our Excel template</p>
        <div class="wrapper-btn-back mt-2">
            <button class="btn btn-primary" routerLink="/students"> <i class="bi bi-arrow-left"></i> Back to Student
                List</button>
        </div>
    </div>


    <!-- Main Upload Card -->
    <div class="card">
        <div class="card-body">

            <!-- Instructions -->
            <div class="instructions">
                <h6><i class="bi bi-info-circle"></i> Getting Started</h6>
                <ul>
                    <li>Download the template file to see the required format</li>
                    <li>Fill in student data in the Excel file</li>
                    <li>Upload the completed file below</li>
                    <li>Maximum file size: 10MB â€¢ Supported formats: .xlsx, .csv</li>
                </ul>
            </div>

            <!-- Upload Mode Selection -->
            <div class="upload-mode">
                <div class="mode-option">
                    <input type="radio" name="uploadMode" id="modeDetailed" value="detailed" [(ngModel)]="uploadMode"
                        [disabled]="uploading">
                    <label for="modeDetailed" class="mode-label">
                        <strong>Detailed</strong>
                        <span>Shows success/failure for each row</span>
                    </label>
                </div>
                <div class="mode-option">
                    <input type="radio" name="uploadMode" id="modeBulk" value="bulk" [(ngModel)]="uploadMode"
                        [disabled]="uploading">
                    <label for="modeBulk" class="mode-label">
                        <strong>Bulk</strong>
                        <span>Faster, recommended for large files</span>
                    </label>
                </div>
            </div>

            <!-- File Upload Area -->
            <div class="upload-area" *ngIf="!fileName">
                <i class="bi bi-cloud-arrow-up"></i>
                <p style="margin-bottom: 1rem; color: var(--secondary-color);">
                    Drag and drop your file here, or click to browse
                </p>
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" (change)="onFileSelected($event)"
                        [disabled]="uploading">
                    <label for="fileInput" class="file-input-button">
                        <i class="bi bi-folder2-open"></i> Choose File
                    </label>
                </div>
            </div>

            <!-- Selected File Display -->
            <div *ngIf="fileName" class="selected-file">
                <div class="selected-file-info">
                    <i class="bi bi-file-earmark-excel-fill"></i>
                    <div>
                        <div class="selected-file-name">{{ fileName }}</div>
                        <small style="color: var(--secondary-color);">Ready to upload</small>
                    </div>
                </div>
                <button type="button" class="remove-file" (click)="clearFile()" [disabled]="uploading"
                    aria-label="Remove file">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons" *ngIf="fileName">
                <button type="button" class="btn btn-primary" (click)="uploadFile()"
                    [disabled]="!selectedFile || uploading">
                    <span *ngIf="uploading" class="spinner-border me-2"></span>
                    <i *ngIf="!uploading" class="bi bi-upload"></i>
                    {{ uploading ? 'Uploading...' : 'Upload File' }}
                </button>

                <button type="button" class="btn btn-secondary" (click)="resetForm()" [disabled]="uploading">
                    <i class="bi bi-arrow-clockwise"></i>
                    Reset
                </button>
            </div>

            <!-- Upload Result Alert -->
            <div *ngIf="uploadResult" class="alert" [ngClass]="{
                    'alert-success': uploadResult.type === 'success',
                    'alert-warning': uploadResult.type === 'warning',
                    'alert-danger': uploadResult.type === 'error'
                }">
                <i class="bi" [ngClass]="{
                        'bi-check-circle-fill': uploadResult.type === 'success',
                        'bi-exclamation-triangle-fill': uploadResult.type === 'warning',
                        'bi-x-circle-fill': uploadResult.type === 'error'
                    }"></i>
                <div class="alert-content">
                    <strong>{{ uploadResult.message }}</strong>
                </div>
                <button type="button" class="alert-close" (click)="uploadResult = null">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

        </div>
    </div>

    <!-- Detailed Results -->
    <div *ngIf="showResults && uploadMode === 'detailed'" class="card">
        <div class="results-header">
            <h5><i class="bi bi-clipboard-data"></i> Upload Results</h5>
        </div>
        <div class="card-body">

            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="summary-card total">
                    <h3>{{ totalCount }}</h3>
                    <p>Total Rows</p>
                </div>
                <div class="summary-card success">
                    <h3>{{ successCount }}</h3>
                    <p>Successful</p>
                </div>
                <div class="summary-card failed">
                    <h3>{{ failedCount }}</h3>
                    <p>Failed</p>
                </div>
            </div>

            <!-- Success Records Table -->
            <div *ngIf="successRecords.length > 0" class="table-section success">
                <h6>
                    <i class="bi bi-check-circle-fill"></i>
                    Successfully Uploaded ({{ successCount }})
                </h6>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Row #</th>
                                <th>Student ID</th>
                                <th>Name (English)</th>
                                <th>Name (Khmer)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let record of successRecords; let i = index">
                                <td>{{ i + 1 }}</td>
                                <td>{{ record.student_id }}</td>
                                <td>{{ record.student.student_name_eng }}</td>
                                <td>{{ record.student.student_name_kh }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Failed Records Table -->
            <div *ngIf="failedRecords.length > 0" class="table-section failed">
                <h6>
                    <i class="bi bi-x-circle-fill"></i>
                    Failed Uploads ({{ failedCount }})
                </h6>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Row #</th>
                                <th>Error</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let record of failedRecords">
                                <td>{{ record.row_number }}</td>
                                <td>
                                    <span class="badge badge-danger">{{ record.error }}</span>
                                </td>
                                <td>
                                    <small style="color: var(--secondary-color);">
                                        {{ record.row_data | json }}
                                    </small>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

</div>